{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RainDrop DeepSearch</title>
    <link rel="stylesheet" href="{% static 'commander/css/style.css' %}">
</head>
<body>
    <!-- Top Section - Title Only -->
    <div class="top-section">
        <div class="grid-pattern"></div>
        <div class="container">
            <div class="title-popup-box">
                <h1 class="section-title">RainDrop DeepSearch</h1>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="container">
            {% if step == "issue_input" %}
                <!-- Step 0: Issue Input Form -->
                <div class="issue-input-stage">
                    <div class="issue-form-card">
                        <h2>Describe Your Issue</h2>
                        <p class="form-subtitle">Tell us what problem you want to detect in your interaction logs</p>
                        
                        <form method="post" class="issue-form">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="issue_text">Issue Description</label>
                                <textarea 
                                    id="issue_text" 
                                    name="issue_text" 
                                    rows="4" 
                                    placeholder="e.g., The assistant fails to search the internet to retrieve documentation"
                                    required
                                ></textarea>
                            </div>
                            
                            <div class="common-issues-section">
                                <p class="common-issues-label">Or select from common issues:</p>
                                <div class="common-issues-grid">
                                    {% for issue in common_issues %}
                                    <button 
                                        type="button" 
                                        class="common-issue-btn"
                                        onclick="fillIssue('{{ issue|escapejs }}')"
                                    >
                                        {{ issue }}
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <button type="submit" name="submit_issue" class="btn-submit-issue">
                                üîç Search for Examples
                            </button>
                        </form>
                    </div>
                </div>
            
            {% elif step == "searching" %}
                <!-- Step 0.5: Loading Screen - Examples are being sampled -->
                <div class="searching-stage">
                    <div class="searching-content">
                        <div class="searching-spinner"></div>
                        <h2 class="searching-title">Searching through millions of production interactions to find examples of your issue</h2>
                        <p class="searching-subtitle">This may take a few moments...</p>
                    </div>
                    <script>
                        setTimeout(function() {
                            window.location.reload();
                        }, 1000);
                    </script>
                </div>
            
            {% elif step == "generating_rules" %}
                <!-- Step 1.5: Rules Generation Loading Screen -->
                <div class="searching-stage">
                    <div class="searching-content">
                        <div class="searching-spinner"></div>
                        <h2 class="searching-title">Generating classification rules from the production examples</h2>
                        <p class="searching-subtitle">These rules will be used to generate training data for your classifier...</p>
                        
                        <!-- Expandable description section -->
                        <div class="expandable-description" style="margin-top: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">
                            <button class="expand-toggle" onclick="toggleDescription()" style="background: rgba(96, 165, 250, 0.1); border: 2px solid #60a5fa; border-radius: 0; color: #60a5fa; cursor: pointer; font-size: 1rem; font-weight: 600; padding: 14px 24px; width: 100%; text-align: center; box-shadow: 3px 3px 0px #0d0d0d; transition: all 0.1s;">
                                <span style="display: block; margin-bottom: 4px;">How will these rules be used?</span>
                                <span id="expand-text" style="color: #bfdbfe; font-size: 0.9rem; font-weight: 500; text-decoration: underline;">Click here to read more...</span>
                            </button>
                            <div id="description-content" style="display: none; margin-top: 20px; padding: 20px; background: rgba(96, 165, 250, 0.1); border: 2px solid #60a5fa; border-radius: 0; text-align: left; line-height: 1.8; box-shadow: inset 2px 2px 0px #0d0d0d;">
                                <div style="color: #bfdbfe; font-size: 0.95rem;">
                                    <ol style="margin-left: 20px; margin-bottom: 15px; padding-left: 10px;">
                                        <li style="margin-bottom: 12px;">
                                            <strong>Rule Generation:</strong> We analyze production examples to create precise classification rules that capture the pattern of your issue.
                                        </li>
                                        <li style="margin-bottom: 12px;">
                                            <strong>Training Data Generation:</strong> These rules will be passed to an LLM to generate thousands of diverse training examples.
                                        </li>
                                        <li style="margin-bottom: 12px;">
                                            <strong>Classifier Training:</strong> A specialized classifier will be trained on these examples to detect your specific issue.
                                        </li>
                                        <li style="margin-bottom: 12px;">
                                            <strong>Production Scanning:</strong> The classifier will scan millions of production logs to find all occurrences of your issue.
                                        </li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        function toggleDescription() {
                            const content = document.getElementById('description-content');
                            const expandText = document.getElementById('expand-text');
                            if (content.style.display === 'none') {
                                content.style.display = 'block';
                                expandText.textContent = 'Click here to hide';
                            } else {
                                content.style.display = 'none';
                                expandText.textContent = 'Click here to read more...';
                            }
                        }
                        setTimeout(function() {
                            window.location.reload();
                        }, 1000);
                    </script>
                </div>
            
            {% elif step == "viewing_examples" %}
                <!-- Step 1: View Production Examples -->
                <div class="examples-stage">
                    {% if user_issue %}
                    <div class="issue-display-in-box" style="margin-bottom: 24px; padding: 16px; background: rgba(96, 165, 250, 0.1); border: 2px solid #60a5fa; border-radius: 0; box-shadow: inset 2px 2px 0px #0d0d0d; max-width: 900px; margin-left: auto; margin-right: auto;">
                        <p style="margin: 0; color: #bfdbfe; font-size: 0.95rem; text-align: center;"><strong style="color: #60a5fa;">Issue:</strong> {{ user_issue }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="stage-header" style="text-align: center; margin-bottom: 30px;">
                        <h2>üìÇ Production Examples Found</h2>
                        <p class="subtitle">We found {{ total_examples }} relevant examples from production data</p>
                    </div>
                    
                    <div class="examples-list" style="max-width: 900px; margin: 0 auto;">
                        {% for example in deepsearch_issue.examples %}
                        <div class="example-card" style="background: #2d2d2d; border: 2px solid #60a5fa; padding: 20px; margin-bottom: 15px; box-shadow: 3px 3px 0px #0d0d0d;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="color: #60a5fa; font-weight: 600;">Example {{ forloop.counter }}</span>
                                {% if example.relevance_score %}
                                <span style="color: #94a3b8; font-size: 0.85rem;">Relevance: {{ example.relevance_score|floatformat:0 }}%</span>
                                {% endif %}
                            </div>
                            <div class="interaction-display">
                                <div class="user-message" style="margin-bottom: 12px; padding: 12px; background: rgba(96, 165, 250, 0.1); border-left: 3px solid #60a5fa;">
                                    <div style="color: #60a5fa; font-weight: 600; font-size: 0.8rem; margin-bottom: 5px;">USER</div>
                                    <p style="color: #bfdbfe; margin: 0; line-height: 1.6;">{{ example.user|truncatewords:100 }}</p>
                                </div>
                                <div class="assistant-message" style="padding: 12px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                                    <div style="color: #3b82f6; font-weight: 600; font-size: 0.8rem; margin-bottom: 5px;">ASSISTANT</div>
                                    <p style="color: #bfdbfe; margin: 0; line-height: 1.6;">{{ example.assistant|truncatewords:100 }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="view_examples_done" value="1">
                            <button type="submit" class="btn-submit-issue" style="font-size: 1.1rem; padding: 15px 40px;">
                                Generate Rules from These Examples ‚Üí
                            </button>
                        </form>
                    </div>
                </div>
            
            {% elif step == "rules_review" %}
                <!-- Step 2: Review Generated Rules -->
                <div class="rules-review-stage">
                    {% if user_issue %}
                    <div class="issue-display-in-box" style="margin-bottom: 24px; padding: 16px; background: rgba(96, 165, 250, 0.1); border: 2px solid #60a5fa; border-radius: 0; box-shadow: inset 2px 2px 0px #0d0d0d; max-width: 900px; margin-left: auto; margin-right: auto;">
                        <p style="margin: 0; color: #bfdbfe; font-size: 0.95rem; text-align: center;"><strong style="color: #60a5fa;">Issue:</strong> {{ user_issue }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="stage-header" style="text-align: center; margin-bottom: 30px;">
                        <h2>üìã Generated Classification Rules</h2>
                        <p class="subtitle">These rules will be used to generate training data for your issue classifier</p>
                        {% if total_rules > 0 %}
                        <p class="subtitle" style="margin-top: 10px; color: #60a5fa; font-weight: 600;">
                            {{ total_rules }} Rule{{ total_rules|pluralize }} Generated
                        </p>
                        {% endif %}
                    </div>
                    
                    <div class="rules-list" style="max-width: 900px; margin: 0 auto;">
                        {% for rule in suggested_rules %}
                        <div class="rule-card" style="background: #2d2d2d; border: 2px solid #60a5fa; padding: 25px; margin-bottom: 20px; box-shadow: 3px 3px 0px #0d0d0d;" data-rule-id="{{ rule.id }}" {% if rule.deployed %}data-deployed="true" style="opacity: 0.6;"{% endif %}>
                            <div class="rule-header" style="margin-bottom: 20px;">
                                <h3 style="color: #60a5fa; font-size: 1.1rem; margin-bottom: 10px;">Rule {{ forloop.counter }}: {{ rule.title }}</h3>
                                {% if rule.description %}
                                <p style="color: #bfdbfe; margin-bottom: 12px; line-height: 1.6;">{{ rule.description }}</p>
                                {% endif %}
                                {% if rule.example %}
                                <div style="padding: 12px; background: rgba(96, 165, 250, 0.1); border-left: 3px solid #60a5fa; margin-top: 10px;">
                                    <strong style="color: #60a5fa;">Example:</strong>
                                    <span style="color: #bfdbfe;">"{{ rule.example|truncatewords:50 }}"</span>
                                </div>
                                {% endif %}
                                {% if rule.keywords %}
                                <div style="margin-top: 12px;">
                                    <strong style="color: #60a5fa; font-size: 0.9rem;">Keywords:</strong>
                                    {% for keyword in rule.keywords %}
                                    <span style="display: inline-block; background: rgba(96, 165, 250, 0.2); color: #bfdbfe; padding: 2px 8px; margin: 2px; font-size: 0.85rem; border: 1px solid #60a5fa;">{{ keyword }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% if rule.training_guidance %}
                                <div style="margin-top: 12px; padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6;">
                                    <strong style="color: #3b82f6; font-size: 0.85rem;">Training Guidance:</strong>
                                    <p style="color: #94a3b8; margin: 5px 0 0 0; font-size: 0.9rem;">{{ rule.training_guidance }}</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="rule-actions" style="display: flex; gap: 10px; margin-top: 20px;">
                                {% if rule.deployed %}
                                    <button class="btn-deploy" disabled style="opacity: 0.6;">‚úÖ Accepted</button>
                                {% else %}
                                <form method="post" style="display: inline;" class="deploy-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="deploy_rule" value="{{ rule.id }}">
                                    <button type="submit" class="btn-deploy" onclick="handleDeploy(event)">‚úÖ Accept Rule</button>
                                </form>
                                {% endif %}
                                <form method="post" style="display: inline;" class="reject-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="reject_rule" value="{{ rule.id }}">
                                    <button type="submit" class="btn-reject">‚ùå Reject</button>
                                </form>
                            </div>
                        </div>
                        {% empty %}
                        <div style="text-align: center; padding: 40px; color: #94a3b8;">
                            <p>No rules were generated. Please try again with a different issue description.</p>
                            <a href="/" style="color: #60a5fa;">‚Üê Back to Home</a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Deploy Loading Overlay -->
    <div id="deployLoadingOverlay" class="deploy-loading-overlay">
        <div class="deploy-loading-content">
            <div class="deploy-loading-spinner"></div>
            <div class="deploy-loading-text">The rule is being prepared for classifier training</div>
            <div class="deploy-loading-subtext">Please wait...</div>
        </div>
    </div>
    
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('deployLoadingOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        });
        
        function fillIssue(issueText) {
            document.getElementById('issue_text').value = issueText;
        }
        
        function handleDeploy(event) {
            event.preventDefault();
            
            const overlay = document.getElementById('deployLoadingOverlay');
            if (overlay) {
                overlay.classList.add('active');
            }
            
            const btn = event.target;
            btn.disabled = true;
            
            setTimeout(() => {
                const form = event.target.closest('form');
                if (form) {
                    if (overlay) {
                        overlay.classList.remove('active');
                    }
                    form.submit();
                }
            }, 3000);
        }
    </script>
</body>
</html>
